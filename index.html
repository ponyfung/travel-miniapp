<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>eMenu Tokyo</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            --ios-blue: #007aff;
            --frosted-bg: rgba(255, 255, 255, 0.65);
            --frosted-blur: saturate(180%) blur(20px);
            --card-radius: 20px;
            --text-dark: #1c1c1e;
            --text-gray: #8e8e93;
            --bg-image-default: url('https://images.unsplash.com/photo-1552560229-f2125c064664?q=80&w=1000&auto=format&fit=crop');
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            /* 背景圖設置 */
            background-image: var(--bg-image, var(--bg-image-default));
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-dark);
            height: 100vh;
            padding-bottom: 90px; /* 預留底部導覽列空間 */
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 通用磨砂卡片樣式 --- */
        .frosted-card {
            background: var(--frosted-bg);
            -webkit-backdrop-filter: var(--frosted-blur);
            backdrop-filter: var(--frosted-blur);
            border-radius: var(--card-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* --- 頂部 Header 區域 --- */
        .header-container {
            padding: 20px 20px 0 20px;
            padding-top: env(safe-area-inset-top, 20px); /* 避開動態島/瀏海 */
        }
        
        .top-bar {
            display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;
        }
        .app-title { 
            font-size: 24px; font-weight: 800; display: flex; align-items: center; 
            cursor: pointer; /* 點擊標題換背景 */
        }
        .currency-info { font-size: 12px; color: var(--text-gray); text-align: right; font-weight: 500; }

        /* --- 日子選擇器 (橫向捲動) --- */
        .day-navigator {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            scrollbar-width: none; /* 隱藏捲軸 Firefox */
        }
        .day-navigator::-webkit-scrollbar { display: none; /* 隱藏捲軸 Chrome/Safari */ }
        
        .day-item {
            min-width: 70px; height: 75px;
            background: rgba(255, 255, 255, 0.5);
            -webkit-backdrop-filter: var(--frosted-blur);
            backdrop-filter: var(--frosted-blur);
            border-radius: 16px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: all 0.2s;
        }
        .day-item.active {
            background: #5e87bb; /* 選中時的深藍色 */
            color: white;
        }
        .day-label { font-size: 12px; opacity: 0.8; margin-bottom: 4px;}
        .day-date { font-size: 24px; font-weight: 700; }

        /* --- 主要內容區 --- */
        .main-content {
            padding: 0 20px;
            opacity: 1; transition: opacity 0.3s;
        }
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin: 25px 0 15px 0;
        }
        .section-title { font-size: 20px; font-weight: 700; }
        .add-btn {
            background: rgba(255,255,255,0.3); backdrop-filter: blur(10px);
            padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;
        }

        /* --- 航班卡片 (特殊樣式) --- */
        .flight-card {
            /* 模仿圖片的藍色漸層 */
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            background: linear-gradient(135deg, #5a81ce 0%, #3a61b0 100%);
            color: white; padding: 20px; position: relative;
            margin-bottom: 20px;
        }
        .edit-icon { 
            position: absolute; top: 15px; right: 15px; font-size: 18px; opacity: 0.7; cursor: pointer;
            padding: 5px; /* 增加點擊範圍 */
        }
        .flight-header { 
            display: flex; justify-content: space-between; margin-bottom: 25px; 
            font-weight: 600; font-size: 14px; opacity: 0.9;
        }
        .flight-time { font-size: 22px; font-weight: 700; color: white;}
        .flight-route {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
        }
        .route-code { font-size: 32px; font-weight: 800; }
        .plane-route-visual { flex: 1; text-align: center; position: relative; color: rgba(255,255,255,0.6); }
        .plane-route-visual i { font-size: 24px; color: white; transform: rotate(90deg); }
        .plane-route-visual::before, .plane-route-visual::after {
            content: ''; position: absolute; top: 50%; width: 35%; height: 2px; border-top: 2px dashed rgba(255,255,255,0.4);
        }
        .plane-route-visual::before { left: 10px; }
        .plane-route-visual::after { right: 10px; }
        .flight-footer { display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 500;}
        .status-badge { background: white; color: #3a61b0; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700;}

        /* --- 行程卡片樣式 --- */
        .itinerary-card {
            display: flex; padding: 20px; margin-bottom: 15px; position: relative;
        }
        .card-icon-box {
            width: 44px; height: 44px; background: #5a81ce; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;
            margin-right: 15px; flex-shrink: 0;
        }
        .card-content { flex: 1; }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 5px; }
        .card-subtitle { font-size: 14px; color: #5a81ce; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center;}
        .card-desc { font-size: 14px; color: var(--text-gray); }
        .card-time { position: absolute; bottom: 20px; left: 20px; font-weight: 700; font-size: 16px; }
        .itinerary-card .card-content { margin-bottom: 30px; /* 留位給時間 */ }
        .itinerary-card .edit-icon { color: var(--text-gray); }

        /* --- 底部導覽列 --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.8);
            -webkit-backdrop-filter: var(--frosted-blur);
            backdrop-filter: var(--frosted-blur);
            border-top: 0.5px solid rgba(0,0,0,0.1);
            display: flex; justify-content: space-around;
            padding: 12px 0; padding-bottom: env(safe-area-inset-bottom, 12px);
            z-index: 100;
        }
        .nav-item {
            text-align: center; font-size: 10px; color: #999; flex: 1;
            display: flex; flex-direction: column; align-items: center;
        }
        .nav-item.active { color: #5a81ce; }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }

        /* --- 編輯彈窗 (Modal) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 1000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { display: flex; }
        .modal-container {
            background: white; width: 85%; max-width: 320px;
            border-radius: 20px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: modalPop 0.3s ease-out;
        }
        @keyframes modalPop {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-title { font-size: 18px; font-weight: 700; text-align: center; margin-bottom: 20px; }
        .modal-input-group { margin-bottom: 15px; }
        .modal-label { display: block; font-size: 12px; color: var(--text-gray); margin-bottom: 5px; }
        .modal-input { 
            width: 100%; padding: 12px; border: 1px solid #eee; background: #f9f9f9;
            border-radius: 10px; font-size: 16px; box-sizing: border-box;
        }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 25px; gap: 15px;}
        .modal-btn {
            flex: 1; padding: 12px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .btn-cancel { background: #f2f2f7; color: var(--text-dark); }
        .btn-save { background: var(--ios-blue); color: white; }
        
        /* 隱藏的文件上傳 Input */
        #bg-upload-input { display: none; }

    </style>
</head>
<body>

    <input type="file" id="bg-upload-input" accept="image/*">

    <div class="header-container">
        <div class="top-bar">
            <div class="app-title" onclick="triggerBgUpload()">
                eMenu Tokyo 
                <i class="ri-image-edit-line" style="font-size: 16px; margin-left: 5px; opacity: 0.5;"></i>
            </div>
            <div class="currency-info">
                目前匯率<br>1 JPY ≈ 0.052 HKD
            </div>
        </div>

        <div class="day-navigator" id="day-nav">
            </div>
    </div>

    <div class="main-content" id="main-container">
        </div>


    <div class="bottom-nav">
        <div class="nav-item active">
            <i class="ri-map-pin-user-fill nav-icon"></i> 行程
        </div>
        <div class="nav-item">
            <i class="ri-map-2-line nav-icon"></i> 地圖
        </div>
        <div class="nav-item">
            <i class="ri-wallet-3-line nav-icon"></i> 記帳
        </div>
        <div class="nav-item">
            <i class="ri-shopping-bag-line nav-icon"></i> 購物
        </div>
        <div class="nav-item">
            <i class="ri-information-line nav-icon"></i> 資訊
        </div>
    </div>


    <div class="modal-overlay" id="edit-modal">
        <div class="modal-container">
            <h3 class="modal-title" id="modal-title">編輯項目</h3>
            <div id="modal-form-content"></div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeModal()">取消</button>
                <button class="modal-btn btn-save" id="modal-save-btn">儲存</button>
            </div>
        </div>
    </div>


    <script>
        // ============================================
        //  1. 資料結構 (Data Model)
        // ============================================
        // 這是整個 App 的核心資料庫。我們預設了一些資料，
        // 當用戶編輯後，會儲存到 LocalStorage 並覆蓋這些預設值。

        let tripData = {
            currentDayIndex: 0, // 目前選中的是第幾天 (0 代表第一天)
            days: [
                {
                    id: 1, label: 'Day 1', date: '08', fullDate: '2025-02-08',
                    // 這裡的 events 陣列存放當天的所有卡片
                    events: [
                        {
                            type: 'flight', // 類型：航班
                            id: 'd1_f1',
                            flightNo: 'HB320 航班前往東京',
                            time: '09:05',
                            fromCode: 'HKG',
                            toCode: 'TYO'
                        },
                        {
                            type: 'activity', // 類型：一般行程
                            id: 'd1_a1',
                            icon: 'ri-train-line', // 使用 RemixIcon 的代碼
                            time: '15:00',
                            title: 'NEX 成田特快',
                            subtitle: '導航: 成田空港駅',
                            desc: '前往新宿'
                        }
                    ]
                },
                {
                    id: 2, label: 'Day 2', date: '09', fullDate: '2025-02-09',
                    events: [
                        {
                            type: 'activity',
                            id: 'd2_a1',
                            icon: 'ri-hotel-bed-line',
                            time: '10:00',
                            title: '飯店 Check-out',
                            subtitle: '新宿哥吉拉飯店',
                            desc: '寄放行李'
                        }
                    ]
                },
                 { id: 3, label: 'Day 3', date: '10', fullDate: '2025-02-10', events: [] },
                 { id: 4, label: 'Day 4', date: '11', fullDate: '2025-02-11', events: [] },
                 { id: 5, label: 'Day 5', date: '12', fullDate: '2025-02-12', events: [] }
            ]
        };

        // ============================================
        //  2. 初始化與資料讀取
        // ============================================
        function initApp() {
            // 嘗試從 LocalStorage 讀取舊資料
            const savedData = localStorage.getItem('myTripData_v2');
            if (savedData) {
                tripData = JSON.parse(savedData);
            }

            // 讀取儲存的背景圖
            const savedBg = localStorage.getItem('customBgImage');
            if(savedBg) {
                document.documentElement.style.setProperty('--bg-image', `url(${savedBg})`);
            }

            // 開始渲染畫面
            renderDayNav();
            renderMainContent();

            // 監聽背景圖上傳
            document.getElementById('bg-upload-input').addEventListener('change', handleBgUpload);
        }

        function saveData() {
            localStorage.setItem('myTripData_v2', JSON.stringify(tripData));
            renderMainContent(); // 儲存後重新渲染內容
        }

        // ============================================
        //  3. 畫面渲染 (Rendering)
        // ============================================

        // 渲染上方日子導覽列
        function renderDayNav() {
            const navContainer = document.getElementById('day-nav');
            navContainer.innerHTML = '';
            tripData.days.forEach((day, index) => {
                const isActive = index === tripData.currentDayIndex;
                navContainer.innerHTML += `
                    <div class="day-item ${isActive ? 'active' : ''}" onclick="switchDay(${index})">
                        <span class="day-label">${day.label}</span>
                        <span class="day-date">${day.date}</span>
                    </div>
                `;
            });
        }

        // 切換日子
        function switchDay(index) {
            tripData.currentDayIndex = index;
            renderDayNav();
            // 加個淡入動畫效果
            const mainContent = document.getElementById('main-container');
            mainContent.style.opacity = 0;
            setTimeout(() => {
                renderMainContent();
                mainContent.style.opacity = 1;
            }, 150);
            saveData(); // 記住用戶最後看哪一天
        }

        // 渲染主要內容區 (核心功能)
        function renderMainContent() {
            const container = document.getElementById('main-container');
            container.innerHTML = '';

            const currentDay = tripData.days[tripData.currentDayIndex];

            // 加入標題欄 "行程安排 + 新增按鈕"
            container.innerHTML += `
                <div class="section-header">
                    <div class="section-title">行程安排</div>
                    <div class="add-btn">+ 新增</div>
                </div>
            `;

            // 遍歷當天的所有事件並產生對應的卡片 HTML
            currentDay.events.forEach(event => {
                if (event.type === 'flight') {
                    container.innerHTML += generateFlightCardHtml(event);
                } else if (event.type === 'activity') {
                    container.innerHTML += generateActivityCardHtml(event);
                }
            });
        }

        // 產生航班卡片 HTML 的函數
        function generateFlightCardHtml(event) {
            return `
                <div class="flight-card frosted-card">
                    <i class="ri-pencil-line edit-icon" onclick="openEditModal('flight', '${event.id}')"></i>
                    <div class="flight-header">
                        <div class="flight-time">${event.time}</div>
                        <div>FLIGHT</div>
                    </div>
                    <div class="flight-route">
                        <div class="route-code">${event.fromCode}</div>
                        <div class="plane-route-visual">
                            <i class="ri-plane-fill"></i>
                        </div>
                        <div class="route-code">${event.toCode}</div>
                    </div>
                    <div class="flight-footer">
                        <div>${event.flightNo}</div>
                        <div class="status-badge">已確認</div>
                    </div>
                </div>
            `;
        }

        // 產生行程卡片 HTML 的函數
        function generateActivityCardHtml(event) {
            return `
                <div class="itinerary-card frosted-card">
                    <i class="ri-pencil-line edit-icon" onclick="openEditModal('activity', '${event.id}')"></i>
                    <div class="card-icon-box">
                        <i class="${event.icon}"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-title">${event.title}</div>
                        <div class="card-subtitle">
                            <i class="ri-navigation-fill" style="margin-right:4px; font-size:12px;"></i>
                            ${event.subtitle}
                        </div>
                        <div class="card-desc">${event.desc}</div>
                    </div>
                    <div class="card-time">${event.time}</div>
                </div>
            `;
        }


        // ============================================
        //  4. 編輯功能與彈窗 (Modal Logic)
        // ============================================
        
        let currentEditEventId = null; // 用來記錄目前正在編輯哪個事件

        function openEditModal(type, eventId) {
            currentEditEventId = eventId;
            const modal = document.getElementById('edit-modal');
            const modalTitle = document.getElementById('modal-title');
            const formContent = document.getElementById('modal-form-content');
            const saveBtn = document.getElementById('modal-save-btn');

            // 找到要編輯的那個事件物件
            const currentDayEvents = tripData.days[tripData.currentDayIndex].events;
            const eventToEdit = currentDayEvents.find(e => e.id === eventId);
            
            if (!eventToEdit) return;

            modalTitle.innerText = type === 'flight' ? '編輯航班' : '編輯行程';
            formContent.innerHTML = ''; // 清空舊表單

            // 根據不同類型動態產生不同的輸入表單
            if (type === 'flight') {
                formContent.innerHTML = `
                    ${createInputHtml('時間', 'time', 'time', eventToEdit.time)}
                    ${createInputHtml('航班編號', 'text', 'flightNo', eventToEdit.flightNo)}
                    <div style="display:flex; gap:10px;">
                        ${createInputHtml('出發地', 'text', 'fromCode', eventToEdit.fromCode)}
                        ${createInputHtml('目的地', 'text', 'toCode', eventToEdit.toCode)}
                    </div>
                `;
            } else {
                formContent.innerHTML = `
                    ${createInputHtml('時間', 'time', 'time', eventToEdit.time)}
                    ${createInputHtml('標題', 'text', 'title', eventToEdit.title)}
                    ${createInputHtml('副標題 (地點)', 'text', 'subtitle', eventToEdit.subtitle)}
                    ${createInputHtml('描述', 'text', 'desc', eventToEdit.desc)}
                `;
            }

            // 設定儲存按鈕的行為
            saveBtn.onclick = () => saveEdit(type);
            modal.classList.add('active');
        }

        // 輔助產生 Input HTML 的函數
        function createInputHtml(label, type, id, value) {
            return `
                <div class="modal-input-group">
                    <label class="modal-label" for="edit-${id}">${label}</label>
                    <input type="${type}" id="edit-${id}" class="modal-input" value="${value}">
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        // 儲存編輯後的資料
        function saveEdit(type) {
            const currentDayEvents = tripData.days[tripData.currentDayIndex].events;
            const eventIndex = currentDayEvents.findIndex(e => e.id === currentEditEventId);
            
            if (eventIndex === -1) return;

            // 從輸入框讀取新值並更新資料物件
            if (type === 'flight') {
                currentDayEvents[eventIndex].time = document.getElementById('edit-time').value;
                currentDayEvents[eventIndex].flightNo = document.getElementById('edit-flightNo').value;
                currentDayEvents[eventIndex].fromCode = document.getElementById('edit-fromCode').value;
                currentDayEvents[eventIndex].toCode = document.getElementById('edit-toCode').value;
            } else {
                currentDayEvents[eventIndex].time = document.getElementById('edit-time').value;
                currentDayEvents[eventIndex].title = document.getElementById('edit-title').value;
                currentDayEvents[eventIndex].subtitle = document.getElementById('edit-subtitle').value;
                currentDayEvents[eventIndex].desc = document.getElementById('edit-desc').value;
            }

            saveData(); // 儲存到 LocalStorage 並重新渲染
            closeModal();
        }

        // ============================================
        //  5. 背景圖更換功能
        // ============================================
        function triggerBgUpload() {
            document.getElementById('bg-upload-input').click();
        }

        function handleBgUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                // 當檔案讀取完成後
                reader.onload = function(e) {
                    const imageDataUrl = e.target.result;
                    // 設定 CSS 變數來變更背景
                    document.documentElement.style.setProperty('--bg-image', `url(${imageDataUrl})`);
                    // 將圖片資料存入 LocalStorage (注意：圖片太大可能會存失敗)
                    try {
                        localStorage.setItem('customBgImage', imageDataUrl);
                    } catch (error) {
                        alert('圖片檔案太大，無法儲存，但本次瀏覽有效。');
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // ============================================
        //  啟動應用程式
        // ============================================
        initApp();

    </script>
</body>
</html>